# .github/workflows/ci-release.yml
name: CI + Snapshot Release

on:
  push:
    branches: [ main ]          # adjust if you use other branches
    tags:
      - 'v6.4-SNAPSHOT'
  pull_request:
    branches: [ main ]

permissions:
  contents: write        # create release + upload assets
  pull-requests: write  # optional PR comment

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:

    # ──────────────────────────────────────────────────────────────
    - name: Checkout (full history)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ──────────────────────────────────────────────────────────────
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    # ──────────────────────────────────────────────────────────────
    - name: Cache Maven
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2-

    # ──────────────────────────────────────────────────────────────
    - name: Build JAR
      run: mvn -B clean package

    # ──────────────────────────────────────────────────────────────
    # 1. Get version from tag (v6.4-SNAPSHOT → 6.4-SNAPSHOT)
    # 2. If no tag, fall back to pom version
    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG=${{ github.ref_name }}        # e.g. v6.4-SNAPSHOT
          VER=${TAG#v}                      # → 6.4-SNAPSHOT
        else
          VER=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        fi
        echo "VERSION=$VER" >> $GITHUB_OUTPUT
        echo "JAR=target/Drugs-${VER}.jar" >> $GITHUB_OUTPUT

    # ──────────────────────────────────────────────────────────────
    # Always upload the JAR as an artifact (downloadable from the run)
    - name: Upload JAR as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Drugs-${{ steps.version.outputs.VERSION }}.jar
        path: ${{ steps.version.outputs.JAR }}

    # ──────────────────────────────────────────────────────────────
    # ----------  ONLY ON TAG  ----------
    - name: Generate clean changelog
      if: startsWith(github.ref, 'refs/tags/')
      id: changelog
      run: |
        PREV=$(git tag --sort=-creatordate | grep '^v' | head -n 2 | tail -n 1 || echo "")
        CUR=${{ github.ref_name }}

        if [ -z "$PREV" ]; then
          RANGE="HEAD"
        else
          RANGE="${PREV}..${CUR}"
        fi

        # One line per commit → will be rendered as markdown list
        LOG=$(git log --pretty=format:"- %h %s (%an)" "$RANGE")
        [ -z "$LOG" ] && LOG="- No new commits"

        # Write to a file (no %0A escaping needed)
        echo "$LOG" > changelog.md
        cat changelog.md   # for debugging

        # Store the whole file as an output
        echo "body<<EOF" >> $GITHUB_OUTPUT
        cat changelog.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    # ──────────────────────────────────────────────────────────────
    - name: Create / Update Snapshot Releasee
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Snapshot ${{ github.ref_name }}
        body_path: changelog.md          # <-- clean markdown, no %0A
        draft: false
        prerelease: false
        files: ${{ steps.version.outputs.JAR }}   # <-- exact JAR path
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}