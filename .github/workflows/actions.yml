name: Release with Auto-Changelog

on:
  push:
    branches: [ main, develop ]          # adjust as needed
    tags:
      - 'v6.4-SNAPSHOT'
  pull_request:
    branches: [ main, develop ]            # v1.0.0, v2.3.4, …

permissions:
  contents: write        # create release + upload assets

jobs:
  release:
    runs-on: ubuntu-latest
    steps:

    # ──────────────────────────────────────────────────────────────
    - name: Checkout repository (full history)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ──────────────────────────────────────────────────────────────
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    # ──────────────────────────────────────────────────────────────
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2-

    # ──────────────────────────────────────────────────────────────
    - name: Build JAR
      run: mvn -B clean package

    # ──────────────────────────────────────────────────────────────
    # Extract version from tag (v1.2.3 → 1.2.3)
    - name: Extract version from tag
      id: version
      run: |
        TAG=${{ github.ref_name }}          # e.g. v1.2.3
        VERSION=${TAG#v}                    # strip leading 'v'
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "JAR_PATH=target/Drugs-${VERSION}.jar" >> $GITHUB_OUTPUT

    # ──────────────────────────────────────────────────────────────
    # Generate changelog (same as before)
    - name: Generate changelog from git history
      id: changelog
      run: |
        PREV_TAG=$(git tag --sort=-creatordate | grep '^v' | head -n 2 | tail -n 1 || echo "")
        CURRENT_TAG=${{ github.ref_name }}

        if [ -z "$PREV_TAG" ]; then
          RANGE="HEAD"
        else
          RANGE="$PREV_TAG..$CURRENT_TAG"
        fi

        LOG=$(git log --pretty=format:"- %h %s (%an)" $RANGE)
        [ -z "$LOG" ] && LOG="- No new commits"

        LOG="${LOG//'%'/%25}"
        LOG="${LOG//$'\n'/%0A}"
        LOG="${LOG//$'\r'/%0D}"

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$LOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    # ──────────────────────────────────────────────────────────────
    - name: Create Release with Exact JAR
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## Changelog

          ${{ steps.changelog.outputs.changelog }}

          **Download:** `Drugs-${{ steps.version.outputs.VERSION }}.jar`
        draft: false
        prerelease: false
        files: ${{ steps.version.outputs.JAR_PATH }}   # ← exact path
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}